@page
@model MainModel
@{
    ViewData["Title"] = "GoMad";
    ViewData["ShowEmergencyFooter"] = true;
}

<section class="main-screen">
  <main class="main-center" role="main">
    <div class="avatar-wrap">
      <div class="avatar-bg">
        <img src="/Imagenes/GoMad%20logo.png" alt="GoMad logo" class="avatar-img" />
      </div>
    </div>

    <h1 class="app-name">GoMad</h1>

    <div class="mic-area">
      <button id="micButton" class="mic-button off" aria-pressed="false" aria-label="Micr√≥fono">
        <span class="mic-ico" aria-hidden="true">
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 0 0-6 0v5a3 3 0 0 0 3 3z" />
            <path d="M19 11a1 1 0 0 0-2 0 5 5 0 0 1-10 0 1 1 0 0 0-2 0 5 5 0 0 0 4 4.9V19a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-3.1A5 5 0 0 0 19 11z" />
          </svg>
        </span>
        <span class="mic-state">APAGADO</span>
      </button>

      <div id="micHint" class="mic-hint">Pulsa para hablar</div>
    </div>

    <button id="callBtn" class="call-pill" aria-label="Llamar">‚òéÔ∏è Llamar</button>
  </main>

  <!-- ====== Solicitudes de contacto de emergencia ====== -->
  @if (Model.EmergencyRequests.Count > 0)
  {
      <div class="emergency-requests-section">
          <h2 class="emergency-section-title">üì¨ Solicitudes de contacto de emergencia</h2>
          <p class="emergency-section-desc">Estas personas quieren ser tu contacto de emergencia. Acepta o rechaza:</p>
          <div class="emergency-request-list">
            @foreach (var phone in Model.EmergencyRequests)
            {
                <div class="emergency-request-card" id="req-@phone.Replace("+","").Replace(" ","")">
                    <span class="emergency-req-phone">üìû @phone</span>
                    <div class="emergency-req-actions">
                        <button class="btn-accept-contact" onclick="respondRequest('@phone', true)">‚úÖ Aceptar</button>
                        <button class="btn-reject-contact" onclick="respondRequest('@phone', false)">‚ùå Rechazar</button>
                    </div>
                </div>
            }
          </div>
      </div>
  }

  <!-- Contactos aceptados -->
  @if (Model.AcceptedContacts.Count > 0)
  {
      <div class="accepted-contacts-section">
          <h2 class="emergency-section-title">‚úÖ Contactos de emergencia</h2>
          @foreach (var c in Model.AcceptedContacts)
          {
              <div class="accepted-contact-card">üìû @c</div>
          }
      </div>
  }

</section>

<!-- Modal: instrucciones para a√±adir contacto -->
<div id="emergencyHelpModal" class="modal-overlay" style="display:none" onclick="closeEmergencyHelp(event)">
  <div class="modal-card">
    <button class="modal-close" onclick="document.getElementById('emergencyHelpModal').style.display='none'">‚úï</button>
    <h2 class="modal-title">üì± ¬øC√≥mo a√±adir un contacto de emergencia?</h2>
    <p class="modal-desc">Tu contacto de emergencia puede ser un familiar, vecino o amigo. Dile que siga estos pasos:</p>
    <ol class="modal-steps">
      <li>Abrir la app <strong>GoMad</strong> en su propio dispositivo.</li>
      <li>Pulsar el men√∫ <strong>‚ò∞</strong> (tres l√≠neas, arriba a la derecha).</li>
      <li>Seleccionar <strong>"üÜò Soy contacto de emergencia"</strong>.</li>
      <li>Introducir <strong>su n√∫mero de tel√©fono</strong>.</li>
      <li>Introducir <strong>tu ID de beneficiario</strong>:
          <span class="modal-user-id">@Model.UserID</span>
      </li>
    </ol>
    <p class="modal-note">Despu√©s, te aparecer√° aqu√≠ una solicitud para que la aceptes.</p>
    <button class="btn-modal-ok" onclick="document.getElementById('emergencyHelpModal').style.display='none'">Entendido</button>
  </div>
</div>

<script>
  function openHelp(){ alert('Para ayuda, llama al soporte o consulta la secci√≥n de ayuda.'); }

  function showEmergencyHelp(){
    document.getElementById('emergencyHelpModal').style.display = 'flex';
  }
  function closeEmergencyHelp(e){
    if(e.target === e.currentTarget) e.currentTarget.style.display = 'none';
  }

  // Responder a solicitud de contacto de emergencia (demo client-side con cookies)
  function respondRequest(phone, accept){
    var card = document.getElementById('req-' + phone.replace(/\+/g,'').replace(/ /g,''));
    if(accept){
      // Mover de requests a accepted
      var requests = (getCookie('GoMad_EmergencyRequests') || '').split(',').filter(x => x && x !== phone);
      setCookie('GoMad_EmergencyRequests', requests.join(','), 3650);
      var accepted = (getCookie('GoMad_AcceptedContacts') || '').split(',').filter(x => x);
      accepted.push(phone);
      setCookie('GoMad_AcceptedContacts', accepted.join(','), 3650);
      card.innerHTML = '<span class="emergency-req-phone">üìû ' + phone + '</span><span class="text-success fw-bold">‚úÖ Aceptado</span>';
    } else {
      var requests = (getCookie('GoMad_EmergencyRequests') || '').split(',').filter(x => x && x !== phone);
      setCookie('GoMad_EmergencyRequests', requests.join(','), 3650);
      card.innerHTML = '<span class="emergency-req-phone">üìû ' + phone + '</span><span class="text-danger">‚ùå Rechazado</span>';
    }
    card.classList.add('resolved');
  }

  function getCookie(name){
    var m = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
    return m ? decodeURIComponent(m[2]) : '';
  }
  function setCookie(name, value, days){
    var d = new Date(); d.setTime(d.getTime() + days*86400000);
    document.cookie = name + '=' + encodeURIComponent(value) + ';expires=' + d.toUTCString() + ';path=/';
  }

  (function(){
    const micBtn = document.getElementById('micButton');
    const hint = document.getElementById('micHint');
    let stream = null;
    let allowed = false;

    function setOff(){
      micBtn.classList.remove('on'); micBtn.classList.add('off');
      micBtn.querySelector('.mic-state').textContent = 'APAGADO';
      micBtn.setAttribute('aria-pressed','false');
      hint.textContent = 'Pulse el bot√≥n circular para hablar';
    }

    function setOn(){
      micBtn.classList.remove('off'); micBtn.classList.add('on');
      micBtn.querySelector('.mic-state').textContent = 'ENCENDIDO';
      micBtn.setAttribute('aria-pressed','true');
      hint.innerHTML = 'Dinos qu√© necesitas<br/>en voz alta';
    }

    micBtn.addEventListener('click', async function(){
      if(!allowed){
        try{
          stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          allowed = true;
          setOn();
        }catch(e){
          allowed = false;
          setOff();
          alert('Permiso denegado o error al acceder al micr√≥fono. Ve a Ajustes para conceder el permiso.');
        }
      } else {
        if(stream){ stream.getTracks().forEach(t=>t.stop()); stream = null; }
        allowed = false;
        setOff();
      }
    });

    setOff();
  })();
</script>
