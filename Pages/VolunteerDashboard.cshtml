@page
@model GoMad.Pages.VolunteerDashboardModel
@{
    ViewData["Title"] = "Panel de Voluntario";
    Layout = null; // Completamente independiente del layout de ancianos
}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GoMad - Panel de Voluntario</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="vol-body">

    <!-- Navbar exclusiva de voluntarios -->
    <nav class="vol-navbar">
        <div class="vol-navbar-brand">
            <img src="/Imagenes/GoMad%20logo.png" alt="GoMad" class="vol-navbar-logo" />
            <span class="vol-navbar-title">GoMad Voluntarios</span>
        </div>
        <div class="vol-navbar-links">
            <button class="vol-nav-link active" data-section="pedidos" onclick="showSection('pedidos')">ğŸ“‹ Pedidos</button>
            <button class="vol-nav-link" data-section="ruta" onclick="showSection('ruta')">ğŸ—ºï¸ Ruta</button>
        </div>
        <div class="vol-navbar-user">
            <span class="vol-navbar-email">@Model.VolunteerEmail</span>
            <form method="post" asp-page-handler="Logout" style="display:inline">
                <button type="submit" class="vol-nav-logout">Cerrar sesiÃ³n</button>
            </form>
        </div>
    </nav>

    <!-- Mobile bottom tabs -->
    <div class="vol-mobile-tabs">
        <button class="vol-mobile-tab active" data-section="pedidos" onclick="showSection('pedidos')">ğŸ“‹<span>Pedidos</span></button>
        <button class="vol-mobile-tab" data-section="ruta" onclick="showSection('ruta')">ğŸ—ºï¸<span>Ruta</span></button>
    </div>

    <div class="vol-main">

        <!-- ====== SECCIÃ“N: PEDIDOS ====== -->
        <section id="section-pedidos" class="vol-section active">
            <div class="vol-section-header">
                <h2>ğŸ“‹ Pedidos pendientes</h2>
                <span class="vol-badge" id="pending-badge">@Model.Orders.Count pendientes</span>
            </div>

            <div class="accordion vol-card-list" id="ordersAccordion">
                @{ int cardIdx = 0; }
                @foreach(var o in Model.Orders)
                {
                    var collapseId = $"collapse-{cardIdx}";
                    var headingId  = $"heading-{cardIdx}";
                    <div class="vol-order-card pending accordion-item" id="order-card-@cardIdx">
                        <!-- Cabecera clicable -->
                        <h2 class="accordion-header" id="@headingId">
                            <button class="accordion-button collapsed vol-accordion-btn" type="button"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#@collapseId"
                                    aria-expanded="false"
                                    aria-controls="@collapseId">
                                <span class="vol-order-status pending-status me-2">â³ Pendiente</span>
                                <span class="vol-order-icon me-2">@o.Icon</span>
                                <span class="vol-order-title">
                                    @o.Street, @o.PostalCode â€” @o.Type
                                </span>
                            </button>
                        </h2>
                        <!-- Cuerpo desplegable -->
                        <div id="@collapseId" class="accordion-collapse collapse"
                             aria-labelledby="@headingId" data-bs-parent="#ordersAccordion">
                            <div class="accordion-body vol-order-body">
                                <p class="vol-order-address">ğŸ“ <strong>DirecciÃ³n:</strong> @o.Street, @o.PostalCode San Esteban de Gormaz</p>
                                <p class="vol-order-detail">ğŸ“ <strong>TelÃ©fono:</strong> @o.Phone</p>
                                <p class="vol-order-detail">@o.Icon <strong>Tipo de pedido:</strong> @o.Type</p>
                                <p class="vol-order-detail vol-buywhere">
                                    ğŸª <strong>DÃ³nde comprarlo:</strong> @o.BuyAt
                                </p>
                                <p class="vol-order-detail">
                                    ğŸ“¦ <strong>Productos:</strong><br/>
                                    <span class="vol-items-list">@o.Items</span>
                                </p>
                                <div class="vol-order-actions mt-2">
                                    <button class="btn-vol-complete" onclick="completeOrder(this, @cardIdx)">ğŸ‰ Marcar como entregado</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    cardIdx++;
                }
            </div>
        </section>

        <!-- ====== SECCIÃ“N: RUTA ====== -->
        <section id="section-ruta" class="vol-section">
            <div class="vol-section-header">
                <h2>ğŸ—ºï¸ Mi ruta de hoy</h2>
            </div>

            <!-- BotÃ³n Google Maps -->
            <div class="vol-maps-cta">
                <a href="@Model.GoogleMapsRouteUrl" target="_blank" rel="noopener noreferrer"
                   class="btn-vol-maps">
                    ğŸ—ºï¸ Abrir ruta completa en Google Maps
                </a>
                <p class="vol-maps-hint">Primero las tiendas y luego las entregas, en el orden mÃ¡s corto.</p>
            </div>

            <!-- Timeline de paradas -->
            <div class="vol-route-timeline">
                @{ int stopIdx = 1; }
                @foreach(var stop in Model.OptimalRoute)
                {
                    <div class="vol-route-stop @(stop.IsStore ? "store-stop" : "house-stop")">
                        <div class="vol-stop-number">@stopIdx</div>
                        <div class="vol-stop-info">
                            <p class="vol-stop-title">
                                @(stop.IsStore ? stop.Icon + " " + stop.Recipient : stop.Icon + " Entrega en " + stop.Street)
                            </p>
                            <p class="vol-stop-address">ğŸ“ @stop.Street, @stop.PostalCode</p>
                            @if (!string.IsNullOrEmpty(stop.Phone))
                            {
                                <p class="vol-stop-detail">ğŸ“ @stop.Phone</p>
                            }
                            @if (stop.IsStore)
                            {
                                <p class="vol-stop-detail">ğŸ›ï¸ @stop.Items</p>
                            }
                            else
                            {
                                <p class="vol-stop-detail">ğŸ“¦ @stop.Items</p>
                                <p class="vol-stop-detail vol-buywhere">ğŸª Comprado en: @stop.BuyAt</p>
                            }
                        </div>
                    </div>
                    stopIdx++;
                }
            </div>
        </section>

    </div>

<script>
    // Section switching
    function showSection(name){
        document.querySelectorAll('.vol-section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.vol-nav-link, .vol-mobile-tab').forEach(b => b.classList.remove('active'));
        document.getElementById('section-'+name).classList.add('active');
        document.querySelectorAll('[data-section="'+name+'"]').forEach(b => b.classList.add('active'));
    }

    // Order completion
    function completeOrder(btn, cardIdx){
        var card = document.getElementById('order-card-' + cardIdx);
        card.classList.remove('pending');
        card.classList.add('done');
        // Update status label inside accordion button
        var statusLabel = card.querySelector('.vol-order-status');
        if(statusLabel){
            statusLabel.textContent = 'âœ… Entregado';
            statusLabel.className = 'vol-order-status done-status me-2';
        }
        // Remove action button
        card.querySelector('.vol-order-actions').innerHTML = '<span class="text-success fw-bold">ğŸ‰ Pedido entregado</span>';
        // Collapse the accordion item
        var collapseEl = card.querySelector('.accordion-collapse');
        if(collapseEl){
            var bsCollapse = bootstrap.Collapse.getInstance(collapseEl);
            if(bsCollapse) bsCollapse.hide();
        }
        updateBadge();
    }
    function updateBadge(){
        var pending = document.querySelectorAll('.vol-order-card.pending').length;
        var badge = document.getElementById('pending-badge');
        if(badge) badge.textContent = pending + ' pendiente' + (pending !== 1 ? 's' : '');
    }
</script>

</body>
</html>
