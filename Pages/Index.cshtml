@page
@model IndexModel
@{
        ViewData["Title"] = "GoMad - Onboarding";
}

<section class="onboard-root">
    <header class="onboard-top">
        <button type="button" class="btn-help" onclick="openHelp()"><span class="help-icon">☎️</span> Ayuda</button>
        <div class="hamburger-wrap">
            <button type="button" class="hamburger-btn" id="hamburgerBtn" aria-label="Abrir menú" onclick="toggleDropdown()">
                <span></span><span></span><span></span>
            </button>
            <div class="hamburger-dropdown" id="hamburgerDropdown">
                <a href="/VolunteerLogin" class="dropdown-link volunteer-link">🤝 Soy voluntario</a>
                <a href="/EmergencyContact" class="dropdown-link emergency-link">🆘 Soy contacto de emergencia</a>
            </div>
        </div>
    </header>

    <main class="onboard-center">
        <img class="gomad-logo" src="/Imagenes/GoMad%20logo.png" alt="GoMad logo" />
        <h1 class="app-title">GoMad</h1>
        <p class="welcome">¡Bienvenido a GoMad!</p>
        <p class="instruction">Introduce tus datos para empezar:</p>

        <form method="post" class="onboard-form" novalidate>
            <div class="input-row phone-row">
                <span class="icon">☎️</span>
                <span class="prefix">+34</span>
                <input asp-for="Phone" class="form-control input-field" type="tel" inputmode="tel" pattern="[0-9 ]+" placeholder="Tu teléfono" aria-label="Tu teléfono" />
                <span asp-validation-for="Phone" class="field-validation"></span>
            </div>

            <div class="input-row">
                <span class="icon">•</span>
                <input asp-for="PostalCode" class="form-control input-field" type="text" inputmode="numeric" pattern="[0-9]{4,5}" placeholder="Código postal" aria-label="Código postal" />
                <span asp-validation-for="PostalCode" class="field-validation"></span>
            </div>

            <div class="input-row">
                <span class="icon">🏠</span>
                <input asp-for="Street" class="form-control input-field" type="text" placeholder="Calle de la vivienda" aria-label="Calle de la vivienda" />
                <span asp-validation-for="Street" class="field-validation"></span>
            </div>

            <div class="permission-card">
                <div class="perm-left">
                    <span class="icon mic">🎤</span>
                </div>
                <div class="perm-right">
                    <div class="perm-title">Permitir micrófono</div>
                    <div class="perm-desc">Necesitamos acceder al micrófono para que puedas pedir cómodamente por voz.</div>
                </div>
                <div class="perm-action">
                    <button type="button" class="btn-permit" id="requestMic">Permitir</button>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn-continue" id="btnContinue">Continuar</button>
            </div>
            <input type="hidden" id="micGranted" name="micGranted" value="0" />
        </form>
    </main>
</section>

<partial name="_ValidationScriptsPartial" />

<script>
    function openHelp(){
        alert('Para ayuda, llama al soporte o consulta la sección de ayuda.');
    }

    // Hamburger dropdown toggle
    function toggleDropdown(){
        var dd = document.getElementById('hamburgerDropdown');
        var btn = document.getElementById('hamburgerBtn');
        dd.classList.toggle('open');
        btn.classList.toggle('active');
    }
    // Close dropdown when clicking outside
    document.addEventListener('click', function(e){
        var wrap = document.querySelector('.hamburger-wrap');
        if(wrap && !wrap.contains(e.target)){
            document.getElementById('hamburgerDropdown')?.classList.remove('open');
            document.getElementById('hamburgerBtn')?.classList.remove('active');
        }
    });

    document.getElementById('requestMic')?.addEventListener('click', async function(){
        try{
            await navigator.mediaDevices.getUserMedia({ audio: true });
            this.textContent = '✅ Permitido';
            this.classList.add('granted');
            document.getElementById('micGranted').value = '1';
        }catch(e){
            alert('No se pudo acceder al micrófono. Comprueba los permisos del dispositivo.');
        }
    });

    // Bloquear envío del formulario si no se han dado permisos de micrófono
    document.querySelector('.onboard-form')?.addEventListener('submit', function(e){
        if(document.getElementById('micGranted').value !== '1'){
            e.preventDefault();
            alert('⚠️ Es necesario que des permisos al micrófono para poder continuar.\n\nPulsa el botón "Permitir" y acepta el permiso.');
            document.getElementById('requestMic')?.focus();
        }
    });
</script>
